import streamlit as st
import pdfplumber
from openai import OpenAI
import os

# ================= é…ç½®åŒº =================
# é¡µé¢åŸºç¡€è®¾ç½®
st.set_page_config(
    page_title="7-Trade å•è¯é£æ§ä¸­å°",
    page_icon="ğŸš¢",
    layout="wide"
)

# ================= æ ¸å¿ƒé€»è¾‘åŒº =================

def extract_text_from_pdf(uploaded_file):
    """ä»PDFæå–æ–‡å­—"""
    text = ""
    try:
        with pdfplumber.open(uploaded_file) as pdf:
            for page in pdf.pages:
                text += page.extract_text() + "\n"
    except Exception as e:
        return f"è¯»å–é”™è¯¯: {e}"
    return text

def analyze_with_ai(doc_text, doc_type, api_key):
    """è°ƒç”¨ AI è¿›è¡Œé£æ§å®¡æŸ¥"""
    
    # è¿™é‡Œæˆ‘ä»¬é…ç½® DeepSeek çš„åœ°å€ï¼ˆæˆ–è€… OpenAIï¼‰
    # å¦‚æœæ˜¯ç”¨ DeepSeekï¼Œbase_url å¿…é¡»å¡«å¯¹
    client = OpenAI(
        api_key=api_key, 
        base_url="https://api.deepseek.com"  # å¦‚æœç”¨ OpenAIï¼ŒæŠŠè¿™è¡Œåˆ æ‰å³å¯
    )

    # æ ¸å¿ƒæŒ‡ä»¤ï¼šæ‰®æ¼”è€ç»ƒçš„å•è¯ä¸“å®¶
    system_prompt = """
    ä½ æ˜¯ä¸€ä½æ‹¥æœ‰20å¹´ç»éªŒçš„å›½é™…è´¸æ˜“å•è¯ä¸“å®¶ï¼ŒæœåŠ¡äº 'Seven O'Clock Resources' å…¬å¸ï¼ˆä¸»è¥æ¶¤çº¶çº±çº¿åº“å­˜è´¸æ˜“ï¼‰ã€‚
    ä½ çš„ä»»åŠ¡æ˜¯å®¡æŸ¥ç”¨æˆ·ä¸Šä¼ çš„è´¸æ˜“å•æ®ï¼ˆå¦‚ä¿¡ç”¨è¯ LCã€åˆåŒ POã€æå• BLï¼‰ã€‚
    
    è¯·æ‰§è¡Œä»¥ä¸‹é£æ§æ£€æŸ¥ï¼š
    1. **è½¯æ¡æ¬¾é™·é˜±**ï¼šæŸ¥æ‰¾æ˜¯å¦æœ‰ 'Receipt of Goods'ã€'Quality Certificate by Applicant' ç­‰å¯¼è‡´è´§åˆ°ä»˜æ¬¾æˆ–å®¢æˆ·æ§åˆ¶æ”¾è´§çš„æ¡æ¬¾ã€‚
    2. **å…³é”®æ•°æ®æ ¸å¯¹**ï¼šæ£€æŸ¥é‡‘é¢ã€æœ€è¿Ÿè£…è¿æœŸ (Latest Shipment)ã€æº¢çŸ­è£…æ¡æ¬¾ (Tolerance)ã€‚
    3. **ç‰¹æ®Šé£é™©**ï¼šå¦‚æœæ˜¯å­ŸåŠ æ‹‰ä¿¡ç”¨è¯ï¼Œç‰¹åˆ«æ³¨æ„æ˜¯å¦æœ‰å¥‡æ€ªçš„æ‰£è´¹æ¡æ¬¾æˆ–ä¸­è½¬è¡Œé™åˆ¶ã€‚
    4. **ä¸€è‡´æ€§æ£€æŸ¥**ï¼šå¦‚æœæ˜¯å¤šä»½æ–‡ä»¶ï¼Œæ£€æŸ¥å•å•æ˜¯å¦ä¸€è‡´ï¼ˆå¦‚æ¯›é‡ã€å‡€é‡ï¼‰ã€‚
    
    è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š
    - ä½¿ç”¨ Markdown æ ¼å¼ã€‚
    - ç¬¬ä¸€éƒ¨åˆ†ï¼šğŸš¨ **é«˜å±é£é™©é¢„è­¦** (ç”¨çº¢è‰²åŠ ç²—æ˜¾ç¤ºè‡´å‘½é—®é¢˜)ã€‚
    - ç¬¬äºŒéƒ¨åˆ†ï¼šâš ï¸ **éœ€æ³¨æ„çš„ç»†èŠ‚** (å¦‚è´¹ç”¨æ‰¿æ‹…ã€ç‰¹æ®Šå•æ®è¦æ±‚)ã€‚
    - ç¬¬ä¸‰éƒ¨åˆ†ï¼šâœ… **æ“ä½œå»ºè®®** (å¦‚ï¼šå»ºè®®ä¿®æ”¹æ¡æ¬¾ã€å»ºè®®æŠ•ä¿ä¸­ä¿¡ä¿)ã€‚
    - è¯­æ°”è¦ä¸“ä¸šã€çŠ€åˆ©ã€ç›´æ¥ã€‚
    """

    user_prompt = f"è¯·å®¡æŸ¥ä»¥ä¸‹ {doc_type} æ–‡ä»¶çš„å†…å®¹ï¼š\n\n{doc_text[:10000]}" # æˆªå–å‰10000å­—é˜²æ­¢è¶…é•¿

    try:
        response = client.chat.completions.create(
            model="deepseek-chat", # å¦‚æœç”¨ OpenAI æ”¹ä¸º "gpt-4o"
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt},
            ],
            temperature=0.1, # ä¿æŒå†·é™ï¼Œä¸è¦èƒ¡ç¼–ä¹±é€ 
            stream=False
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"AI è¿æ¥å¤±è´¥: {e} (è¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®)"

# ================= ç•Œé¢ UI åŒº =================

# ä¾§è¾¹æ 
with st.sidebar:
    st.image("https://img.icons8.com/color/96/polyester.png", width=50) # å¯ä»¥æ¢æˆæ‚¨çš„ Logo URL
    st.title("Seven O'Clock Resources")
    st.markdown("---")
    api_key_input = st.text_input("è¯·è¾“å…¥ AI å¯†é’¥ (API Key)", type="password")
    st.info("ğŸ’¡ å¯†é’¥ä»…ä¿å­˜åœ¨å½“å‰æµè§ˆå™¨ï¼Œåˆ·æ–°å³æ¶ˆå¤±ï¼Œå®‰å…¨æ— å¿§ã€‚")
    st.markdown("---")
    st.markdown("**æ”¯æŒæ–‡ä»¶ç±»å‹**ï¼š\n- ä¿¡ç”¨è¯ (LC)\n- é‡‡è´­åˆåŒ (PO)\n- å½¢å¼å‘ç¥¨ (PI)")

# ä¸»ç•Œé¢
st.title("ğŸ›¡ï¸ 7-Trade æ™ºèƒ½å•è¯é£æ§ä¸­å¿ƒ")
st.markdown("### Upload Documents & Detect Risks Instantly")

col1, col2 = st.columns([1, 1])

with col1:
    st.subheader("ğŸ“‚ æ­¥éª¤ 1ï¼šä¸Šä¼ æ–‡ä»¶")
    uploaded_file = st.file_uploader("æ‹–æ‹½ PDF æ–‡ä»¶åˆ°è¿™é‡Œ", type=["pdf"])
    
    doc_type = st.selectbox(
        "è¿™æ˜¯ä»€ä¹ˆæ–‡ä»¶ï¼Ÿ",
        ("ä¿¡ç”¨è¯ (L/C)", "é”€å”®åˆåŒ (SC)", "é“¶è¡Œæ‰˜æ”¶æŒ‡ç¤º (Collection)")
    )

    if uploaded_file and api_key_input:
        if st.button("ğŸš€ å¼€å§‹ AI æé€Ÿå®¡å•", type="primary"):
            with st.spinner("AI æ­£åœ¨é€å­—é˜…è¯»æ¡æ¬¾ï¼Œè¯·å¯»æ‰¾æ½œåœ¨é™·é˜±..."):
                # 1. æå–æ–‡å­—
                file_text = extract_text_from_pdf(uploaded_file)
                # 2. AI åˆ†æ
                if len(file_text) > 50:
                    result = analyze_with_ai(file_text, doc_type, api_key_input)
                    st.session_state['result'] = result
                else:
                    st.error("æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–æ— æ³•è¯†åˆ«ï¼Œè¯·ä¸Šä¼ æ¸…æ™°çš„ PDFã€‚")

with col2:
    st.subheader("ğŸ“Š æ­¥éª¤ 2ï¼šé£æ§æŠ¥å‘Š")
    if 'result' in st.session_state:
        st.success("åˆ†æå®Œæˆï¼")
        st.markdown(st.session_state['result'])
        st.download_button(
            label="ğŸ“¥ ä¸‹è½½é£æ§æŠ¥å‘Š",
            data=st.session_state['result'],
            file_name="Risk_Report.md",
            mime="text/markdown"
        )
    else:
        st.info("ğŸ‘ˆ è¯·åœ¨å·¦ä¾§ä¸Šä¼ æ–‡ä»¶å¹¶ç‚¹å‡»å¼€å§‹æŒ‰é’®")

# åº•éƒ¨ç‰ˆæƒ
st.markdown("---")
st.caption("Â© 2026 Seven O'Clock Resources | Internal Use Only | Powered by 7-Trade OS")